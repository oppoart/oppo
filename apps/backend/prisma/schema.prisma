generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  emailVerified     Boolean             @default(false)
  name              String?
  image             String?
  preferences       Json?               // User-level preferences for AI matching and notifications
  settings          Json?               // General app settings and configuration
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  profiles          ArtistProfile[]
  sessions          Session[]
  accounts          Account[]
  passwordResetTokens PasswordResetToken[]
  activities        UserActivity[]      // Track user interactions
  queryBuckets      QueryBucket[]       // User's saved search queries
  
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model ArtistProfile {
  id               String   @id @default(cuid())
  userId           String
  name             String
  mediums          String[] @default(["other"]) // generative art, textile art, new media art, AI art, etc.
  bio              String?
  artistStatement  String?
  skills           String[]
  interests        String[]
  experience       String?
  location         String?
  website          String?
  portfolioUrl     String?
  preferences      Json?
  settings         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("artist_profiles")
}

model Opportunity {
  id               String             @id @default(cuid())
  title            String
  organization     String?            // Added: Organization/Institution name
  description      String
  url              String
  deadline         DateTime?
  amount           String?
  location         String?
  tags             String[]
  
  // Discovery System Fields
  sourceType       String             // 'websearch', 'social', 'bookmark', 'newsletter'
  sourceUrl        String?            // Original source URL where found
  sourceMetadata   Json?              // API response data, social post info, etc.
  discoveredAt     DateTime           @default(now())
  lastUpdated      DateTime           @default(now()) @updatedAt
  
  // Processing Fields
  relevanceScore   Float?
  semanticScore    Float?             // AI semantic similarity score
  keywordScore     Float?             // Keyword matching score
  categoryScore    Float?             // Category/medium matching score
  aiServiceUsed    String?            // Which AI service was used for analysis
  processingTimeMs Int?               // Time taken to process this opportunity
  processed        Boolean            @default(false)
  
  // User Interaction Fields
  status           String             @default("new") // 'new', 'reviewing', 'applying', 'submitted', 'rejected', 'archived'
  applied          Boolean            @default(false)
  notes            String?            // User notes about this opportunity
  starred          Boolean            @default(false) // User bookmarked/starred
  
  // Relationships
  matches          OpportunityMatch[]
  sourceLinks      OpportunitySourceLink[]
  duplicates       OpportunityDuplicate[] @relation("MasterOpportunity")
  duplicateOf      OpportunityDuplicate[] @relation("DuplicateOpportunity")

  @@map("opportunities")
}

model OpportunityMatch {
  id            String      @id @default(cuid())
  opportunityId String
  matchScore    Float
  reasoning     String?
  createdAt     DateTime    @default(now())
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])

  @@map("opportunity_matches")
}

// Discovery System Models

model OpportunitySource {
  id           String        @id @default(cuid())
  name         String        // Human-readable name (e.g., "ArtConnect", "Instagram", "Arts.gov")
  type         String        // 'websearch', 'social', 'bookmark', 'newsletter'
  url          String?       // Base URL for scraping sources
  enabled      Boolean       @default(true)
  lastScanned  DateTime?     // Last successful scan
  successCount Int           @default(0) // Number of successful scans
  errorCount   Int           @default(0) // Number of failed scans
  config       Json?         // Source-specific configuration (search terms, hashtags, etc.)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Relationships
  sourceLinks   OpportunitySourceLink[]
  discoveryJobs DiscoveryJob[]

  @@map("opportunity_sources")
}

model OpportunitySourceLink {
  id            String            @id @default(cuid())
  opportunityId String
  sourceId      String
  discoveredAt  DateTime          @default(now())
  
  // Relationships
  opportunity   Opportunity       @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  source        OpportunitySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, sourceId])
  @@map("opportunity_source_links")
}

model DiscoveryJob {
  id              String            @id @default(cuid())
  sourceId        String?
  sourceType      String            // 'websearch', 'social', 'bookmark', 'newsletter', 'manual'
  sourceName      String?
  status          String            @default("pending") // 'pending', 'running', 'completed', 'failed', 'cancelled'
  startedAt       DateTime?
  completedAt     DateTime?
  opportunitiesFound Int            @default(0)
  errors          Json?             // Array of error messages
  metadata        Json?             // Job-specific data (search queries, hashtags, etc.)
  processingTimeMs Int?             // Total job execution time
  createdAt       DateTime          @default(now())
  
  // Relationships
  source          OpportunitySource? @relation(fields: [sourceId], references: [id])

  @@map("discovery_jobs")
}

model OpportunityDuplicate {
  id                    String      @id @default(cuid())
  masterOpportunityId   String      // The opportunity we keep
  duplicateOpportunityId String     // The opportunity we mark as duplicate
  similarityScore       Float       // How similar they are (0-1)
  mergeStrategy         String?     // How duplicates were handled
  createdAt             DateTime    @default(now())
  
  // Relationships
  masterOpportunity     Opportunity @relation("MasterOpportunity", fields: [masterOpportunityId], references: [id], onDelete: Cascade)
  duplicateOpportunity  Opportunity @relation("DuplicateOpportunity", fields: [duplicateOpportunityId], references: [id], onDelete: Cascade)

  @@unique([masterOpportunityId, duplicateOpportunityId])
  @@map("opportunity_duplicates")
}

// AI Service Performance Tracking

model AIServiceMetrics {
  id              String    @id @default(cuid())
  serviceName     String    // 'openai', 'anthropic', 'google', etc.
  operation       String    // 'embedding', 'analysis', 'search', etc.
  responseTimeMs  Int       // Response time in milliseconds
  success         Boolean   // Whether the operation succeeded
  costUsd         Float?    // Cost in USD if available
  qualityScore    Float?    // Quality assessment (0-1)
  errorMessage    String?   // Error details if failed
  metadata        Json?     // Additional metrics data
  createdAt       DateTime  @default(now())

  @@map("ai_service_metrics")
}

// User Interaction Tracking

model UserActivity {
  id            String    @id @default(cuid())
  userId        String
  activityType  String    // 'opportunity_viewed', 'status_changed', 'starred', 'applied', etc.
  entityType    String    // 'opportunity', 'profile', 'search', etc.
  entityId      String?   // ID of the entity being acted upon
  metadata      Json?     // Activity-specific data
  createdAt     DateTime  @default(now())
  
  // Relationships
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_activities")
}

model QueryBucket {
  id        String   @id @default(cuid())
  userId    String
  profileId String?  // Optional - can be associated with a specific artist profile
  query     String
  source    String   @default("manual") // 'manual', 'generated', 'ai'
  tags      String[] // Optional tags for organization
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, query]) // Prevent duplicate queries per user
  @@map("query_buckets")
}
